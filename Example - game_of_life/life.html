<!DOCTYPE html>
<html lang="en"> 
<head>
<meta charset="utf-8">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Conway's game of life</title>
<link rel="shortcut icon" href="data:,">
<style>
/*  the above empty icon shuts the favicon stuff up.
	put stmt above style if you want favicon: <link rel="shortcut icon" href="favicon.ico" />
    this disables the annoying double click highlighting of DIV blocks 
	see more meta options at https://matt.might.net/articles/how-to-native-iphone-ipad-apps-in-javascript/  
*/
div { outline-style:none;}
div:hover { cursor:default; }
/*  this customizes the default scrollbar appearance */
::-webkit-scrollbar { width: 6pt; }
::-webkit-scrollbar-corner { background: transparent; }
::-webkit-scrollbar-track {
    box-shadow: inset 0 0 15px grey; 
    border-radius: 6pt; }
::-webkit-scrollbar-thumb {
    background: OliveDrab; 
    border-radius: 6pt; }
::-webkit-scrollbar-thumb:hover { background: Olive; }
</style>
</head>
<body style="margin:0; padding:0;position:fixed;">
<script type="module">
// beads ver 0.47 compiled Wed Nov 17 12:26:38 GMT-0800 2021
import { U, Y, N, POP, VAL, VNP, setv, gets, getn, adr, lgp, log } from '../../runtime_047/beads_std.js';
import * as std from '../../runtime_047/beads_std.js';
import * as str from '../../runtime_047/beads_str.js';
export const CODE_HASH = 0xdba99493;
const _M = std.MODULES.push("life")-1;
std.rtl_init();
std.aaaa.main_init = main_init;
std.aaaa.main_drawer = new std.a_function(_M, "main_draw", main_draw);
//------- enums
//-------  func const for life
const draw_board_F = new std.a_function(_M, "draw_board", draw_board);
std.FUNCS[draw_board_F.hash]=draw_board_F;
const calc_next_frame_F = new std.a_function(_M, "calc_next_frame", calc_next_frame);
std.FUNCS[calc_next_frame_F.hash]=calc_next_frame_F;
//-------  top nodes
const NCOL = 30;
const NROW = 20;
let board = new std.a_tree(_M,"board", std.NF_TOPLEVEL|std.NF_STATEFUL|std.NF_LOGGED);
let prev = new std.a_tree(_M,"prev", std.NF_TOPLEVEL|std.NF_STATEFUL|std.NF_LOGGED);

//====================
//   draw_board
//====================
function draw_board(b) {
std.k_enter(b);
std.div_begin(b, new std.a_function(_M, "draw_board_cell", draw_board_cell, null), false, false, false);
  std.div_spa(b, 0, 1, std.al);
  var loop102 = new std.a_loop({ limit:NCOL });
  while (loop102.next()) {
    std.div_add(b, U, 0, 12, std.al, null, 0);
    std.div_spa(b, 0, 1, std.al);
  }
  std.div_spa(b, 1, 1, std.al);
  var loop103 = new std.a_loop({ limit:NROW });
  while (loop103.next()) {
    std.div_add(b, U, 1, 12, std.al, null, 0);
    std.div_spa(b, 1, 1, std.al);
  }
  std.div_end(b);
  //--under
  std.draw_rect(b, { fill:std.LIGHT_BLUE, corner:std.pt_to_dots(b, 2) });
  std.draw_grid(b);
std.k_leave(b);
}


//====================
//   draw_board_cell
//====================
function draw_board_cell(b) {
  std.k_enter(b);
  if (getn(board, getn(b.extra, std.F_cell, std.F_x), getn(b.extra, std.F_cell, std.F_y)) === Y) {
    std.draw_rect(b, { fill:std.DODGER_BLUE, corner:std.mul(b.bounds.height, 0.2) });
  }
  std.k_leave(b);
}

//====================
//   main_draw
//====================
export function main_draw(b) {
std.k_enter(b);
  std.draw_rect(b, { fill:0x224140, corner:std.pt_to_dots(b, 4) });
  let inner = new std.a_tree(_M,"inner", 0, std.solve_rect({ basis:std.adr(b.extra, std.F_box), pin:5, inset:std.pt_to_dots(b, 20), aspect:std.div(NCOL, NROW) }));
  var b20=std.k_layer(b, draw_board_F, { area:inner });
  draw_board(b20);
std.k_leave(b);
}


//====================
//   calc_next_frame
//====================
function calc_next_frame() {
  std.swap_tree(_M, 38, std.adr(board), std.adr(prev));
  var loop104 = new std.a_loop({ from:1, to_:NCOL });
  while (loop104.next()) {
  var col = loop104.index;
    var loop105 = new std.a_loop({ from:1, to_:NROW });
    while (loop105.next()) {
    var row = loop105.index;
      let n = count_neighbors(col, row);
      if (getn(prev, col, row) === Y) {
        std.path_setv(_M, 47, std.adr(board, col, row), std.or4(std.eq4(n, 2), std.eq4(n, 3)));
      } else {
        std.path_setv(_M, 50, std.adr(board, col, row), std.eq4(n, 3));
      }
    }
  }
}


//====================
//   count_neighbors
//====================
function count_neighbors(col, row) {
  let n = 0;
  var loop106 = new std.a_loop({ from:-1, to_:1 });
  while (loop106.next()) {
  var dx = loop106.index;
    var loop107 = new std.a_loop({ from:-1, to_:1 });
    while (loop107.next()) {
    var dy = loop107.index;
      if ((std.ne2(dx, 0) || std.ne2(dy, 0))) {
        if (getn(prev, std.add(col, dx), std.add(row, dy)) === Y) {
          n = std.add(n, 1);
        }
      }
    }
  }
  return n;
}


//====================
//   main_init
//====================
export function main_init() {
  std.path_setv(_M, 15, std.adr(board, 3, 1), Y);
  std.path_setv(_M, 16, std.adr(board, 3, 2), Y);
  std.path_setv(_M, 17, std.adr(board, 3, 3), Y);
  std.path_setv(_M, 18, std.adr(board, 2, 3), Y);
  std.path_setv(_M, 19, std.adr(board, 1, 2), Y);
  std.path_setv(_M, 21, std.adr(board, 23, 1), Y);
  std.path_setv(_M, 22, std.adr(board, 21, 2), Y);
  std.path_setv(_M, 23, std.adr(board, 20, 3), Y);
  std.path_setv(_M, 24, std.adr(board, 20, 4), Y);
  std.path_setv(_M, 25, std.adr(board, 20, 5), Y);
  std.path_setv(_M, 26, std.adr(board, 21, 5), Y);
  std.path_setv(_M, 27, std.adr(board, 22, 5), Y);
  std.path_setv(_M, 28, std.adr(board, 23, 5), Y);
  std.path_setv(_M, 29, std.adr(board, 24, 5), Y);
  std.path_setv(_M, 30, std.adr(board, 25, 4), Y);
  std.path_setv(_M, 31, std.adr(board, 25, 2), Y);
  std.loom_timer(calc_next_frame_F, { rate:4, delay:std.meas(1, std.N_sec, std.Y_Time), reps:60 });
}

std.setv(_M, 0, std.runtime, std.F_app_name, "life");
main_init();
std.rebuild_all();

</script>
</body>
</html>
